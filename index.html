<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebRTC C√°mara ‚Äì Emisor / Viewer</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; text-align:center; }
    video { width:80%; margin:10px; background:#000; border-radius:8px; }
    select,input,button { margin:5px; padding:6px; }
    #controls label { display:block; margin:10px; }
  </style>
</head>
<body>
  <h2>WebRTC C√°mara ‚Äì Emisor / Viewer</h2>

  <label>Rol:
    <select id="roleSel">
      <option value="emitter">Emitter (cam)</option>
      <option value="viewer">Viewer (solo ve)</option>
    </select>
  </label>

  <label>Sala: <input id="roomInp" value="casa1"></label>

  <div id="emitterOpts">
    <label><input type="checkbox" id="mirrorChk"> Espejo</label>
    <label><input type="checkbox" id="audioChk"> Enviar audio</label>
  </div>

  <button id="startBtn">Iniciar</button>
  <button id="stopBtn">Detener</button>
  <p id="status">‚è≥ Esperando‚Ä¶</p>

  <video id="videoEl" autoplay playsinline></video>

  <p>Comparte este link con el Viewer cuando seas Emisor:</p>
  <code id="shareUrl"></code>

  <!-- Controles para Viewer -->
  <div id="controls" style="margin-top:20px; display:none;">
    <h3>üéõ Controles de c√°mara</h3>
    <div><label>Zoom:
      <input type="range" id="zoom" min="1" max="5" step="0.1" value="1">
      <span id="zoomVal">1.0</span>x
    </label></div>
    <div><label>Enfoque:
      <input type="range" id="focus" min="0" max="1" step="0.01" value="0.5">
      <span id="focusVal">0.50</span>
    </label></div>
    <div><label>Balance de blancos:
      <select id="wb">
        <option value="auto">Auto</option>
        <option value="daylight">Luz d√≠a</option>
        <option value="cloudy">Nublado</option>
        <option value="fluorescent">Fluorescente</option>
        <option value="incandescent">Incandescente</option>
      </select>
    </label></div>
  </div>

  <!-- Caja para mostrar capabilities -->
  <div id="capabilitiesBox" style="margin-top:20px; display:none;">
    <h3>üì∑ Capacidades de la c√°mara (Emisor)</h3>
    <pre id="capsOutput" style="background:#111;color:#0f0;padding:10px;max-height:260px;overflow:auto;border-radius:10px;"></pre>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDb_q-2SL_x-Xj4aBrpN4D57N7zMgQmYjw",
  authDomain: "camara-ipad.firebaseapp.com",
  projectId: "camara-ipad",
  storageBucket: "camara-ipad.firebasestorage.app",
  messagingSenderId: "891674821126",
  appId: "1:891674821126:web:c3cefb5dc4cbc5f08f7987"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const roleSel = document.getElementById('roleSel');
const roomInp = document.getElementById('roomInp');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const statusEl = document.getElementById('status');
const videoEl = document.getElementById('videoEl');
const mirrorChk = document.getElementById('mirrorChk');
const audioChk = document.getElementById('audioChk');
const shareUrl = document.getElementById('shareUrl');
const controlsDiv = document.getElementById('controls');

let pc, localStream, roomId;

function updateUI() {
  document.getElementById('emitterOpts').style.display = (roleSel.value === 'emitter') ? 'block':'none';
  controlsDiv.style.display = (roleSel.value === 'viewer') ? 'block':'none';
  document.getElementById('capabilitiesBox').style.display = (roleSel.value === 'viewer') ? 'block':'none';
  const base = location.origin + location.pathname;
  const r = roomInp.value.trim()||'demo';
  shareUrl.textContent = `${base}?room=${encodeURIComponent(r)}&role=viewer`;
  videoEl.style.transform = (mirrorChk.checked && roleSel.value==='emitter')?'scaleX(-1)':'none';
}
roleSel.onchange = updateUI; roomInp.oninput = updateUI; mirrorChk.oninput=updateUI; updateUI();

startBtn.onclick = async () => {
  roomId = roomInp.value.trim()||'demo';
  const iceServers = [
    { urls:'stun:stun.l.google.com:19302' },
    { urls:'turn:global.relay.metered.ca:80', username:'openai', credential:'openai123' }
  ];
  pc = new RTCPeerConnection({iceServers});
  pc.onicecandidate = e=>{
    if(e.candidate){
      db.collection('rooms').doc(roomId).collection(roleSel.value==='emitter'?'callerCandidates':'calleeCandidates').add(e.candidate.toJSON());
    }
  };
  pc.ontrack = e=> videoEl.srcObject = e.streams[0];

  if(roleSel.value==='emitter'){
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:audioChk.checked });
    videoEl.srcObject = localStream;
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

    // === enviar capabilities ===
    try {
      const track = localStream.getVideoTracks()[0];
      let caps = track.getCapabilities? track.getCapabilities() : {note:"no soportado"};
      caps._sentAt = Date.now();
      caps._ua = navigator.userAgent;
      await db.collection('rooms').doc(roomId).collection('control').doc('capabilities').set(caps);
    } catch(e){ console.error(e); }

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await db.collection('rooms').doc(roomId).set({offer});
    db.collection('rooms').doc(roomId).onSnapshot(async snap=>{
      const data=snap.data();
      if(data?.answer && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    });
    db.collection('rooms').doc(roomId).collection('calleeCandidates').onSnapshot(snap=>{
      snap.docChanges().forEach(c=>c.type==='added'&&pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
    });
  } else {
    const room = await db.collection('rooms').doc(roomId).get();
    if(!room.exists){ alert('No existe sala'); return;}
    const offer=room.data().offer;
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await db.collection('rooms').doc(roomId).update({answer});
    db.collection('rooms').doc(roomId).collection('callerCandidates').onSnapshot(snap=>{
      snap.docChanges().forEach(c=>c.type==='added'&&pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
    });
    // escuchar capabilities
    db.collection('rooms').doc(roomId).collection('control').doc('capabilities')
      .onSnapshot(doc=>{
        document.getElementById('capsOutput').textContent = doc.exists ? JSON.stringify(doc.data(),null,2) : 'Esperando...';
      });
  }
  statusEl.innerHTML='<span style="color:lime">Conectado</span>';
};

stopBtn.onclick=()=>{ pc&&pc.close(); pc=null; statusEl.textContent='Detenido'; };
</script>
</body>
</html>
